<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>幻の島シミュレーション</title>
  <style>
    /* ======================================
       PC向け (768px超) のデフォルトレイアウト
       ====================================== */
    #container {
      display: flex;           /* 左右に分割 */
      flex-direction: row;
      width: 1200px;           /* PC向けは横幅固定 */
      margin: 0 auto;          /* 画面中央寄せ */
      height: 700px;           /* Canvas高さに合わせる */
      align-items: flex-start; 
    }
    #left-pane {
      /* キャンバス部分 */
    }
    #right-pane {
      width: 200px;            /* 右側ペインの幅 */
      padding: 10px;
      border-left: 1px solid black;
      font-family: Arial, sans-serif;
      overflow-y: auto;
      box-sizing: border-box;
    }
    /* PC向けキャンバスは width=1000px, height=700px (HTML属性で設定) */
    canvas {
      border: 1px solid black;
      display: block;
    }

    /* ================================
       スマホ向け (768px以下) メディアクエリ
       ================================ */
    @media screen and (max-width: 768px) {
      /* コンテナを上下配置に */
      #container {
        flex-direction: column;   /* 上下に並べる */
        width: 100%;              /* 横幅を100%に */
        height: auto;            /* 高さは自動 */
      }
      /* 右ペインは横区切り → 上端に区切り線 */
      #right-pane {
        border-left: none;
        border-top: 1px solid black;
        width: 100%;
        padding: 10px;
      }
      /* Canvas を画面幅に合わせて縮小 (heightは自動計算) */
      canvas {
        width: 100% !important;
        height: auto !important;
      }
    }

    /* オーバーレイ (選択ドロップダウンなど) */
    .overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
      display: flex; align-items: center; justify-content: center;
    }
    .popup {
      background-color: white;
      padding: 20px;
      border-radius: 5px;
    }
    button {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <!-- タブ切り替え部分 -->
  <div style="padding:10px; border-bottom:1px solid #ccc;">
    <button id="simulationTab">シミュレーション</button>
    <button id="adventureTab">冒険団管理</button>
  </div>

  <!-- シミュレーション画面 -->
  <div id="simulationSection">
    <div id="container">
      <div id="left-pane">
        <!-- PC時: 1000×700, スマホ時はCSSで100%に縮小 -->
        <canvas id="gameCanvas" width="1000" height="700"></canvas>
      </div>
      <div id="right-pane">
        <h3>得点表示</h3>
        <div id="scores"></div>
        <button id="resetButton">リセット</button>
        <h3>詳細</h3>
        <!-- どの冒険団がどのマスを占領し、何点かを表示する場所 -->
        <div id="details">（詳細情報表示エリア）</div>
      </div>
    </div>
  </div>

  <!-- 冒険団管理画面 -->
  <div id="adventureSection" style="display:none; padding:10px;">
    <h3>冒険団の新規作成/編集</h3>
    <div>
      <button id="refreshGroupListBtn">冒険団一覧更新</button>
    </div>
    <div id="groupList"></div>
    <form id="groupForm">
      <div>
        <label>冒険団名: </label>
        <input type="text" id="groupNameInput" required />
      </div>
      <div>
        <label>陣地ID: </label>
        <select id="territorySelect"></select>
      </div>
      <div>
        <label>アクティブ値: </label>
        <!-- 3億など文字入力OK -->
        <input type="text" id="activeInput" value="0" required />
      </div>
      <div>
        <label>上位5人の戦力値:</label><br>
        <input type="number" class="battleInput" step="any" value="0" required />
        <input type="number" class="battleInput" step="any" value="0" required />
        <input type="number" class="battleInput" step="any" value="0" required />
        <input type="number" class="battleInput" step="any" value="0" required />
        <input type="number" class="battleInput" step="any" value="0" required />
      </div>
      <button type="submit">保存</button>
    </form>
    <div id="adventureResult" style="margin-top:10px; color:blue;"></div>
  </div>

  <script>
    /*
      ここにJavaScriptロジックをフル実装
      以下は参考例として、前回までの流れをまとめたもの。
      実際には /api/map, /api/scores, /api/adventure_groups, /api/assign_team
      等が既にapp.pyで定義されている想定。
    */

    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    let nodes = {};                // /api/map の結果
    let adventureGroupsCache = {}; // /api/adventure_groups の結果

    // ノード種別→描画サイズ
    const NODE_SIZES = {
      "コンビニ": 15,
      "スーパー": 20,
      "ホール": 25,
      "陣地": 30,
      "中心大厦": 35
    };

    // マップ描画を多少ずらしたいなら変更
    const MAP_OFFSET_X = 80;
    const MAP_OFFSET_Y = 60;

    // タブ切り替え
    const simulationSection = document.getElementById("simulationSection");
    const adventureSection  = document.getElementById("adventureSection");
    document.getElementById("simulationTab").onclick = () => {
      simulationSection.style.display = "block";
      adventureSection.style.display  = "none";
    };
    document.getElementById("adventureTab").onclick = () => {
      simulationSection.style.display = "none";
      adventureSection.style.display  = "block";
      fetchAdventureGroups();
    };

    // 初期ロード
    loadMap();
    fetchAdventureGroups();
    fetchTerritoryList();

    //======================================
    // マップ & 得点表示 & 詳細情報
    //======================================
    function loadMap() {
      fetch("/api/map")
        .then(r => r.json())
        .then(data => {
          nodes = data;
          drawAll();
          buildDetailInfo();  // 詳細情報:誰がどのマスを占領,その得点
        });
    }

    function drawAll() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawLinks();
      drawNodes();
      refreshScores(); // /api/scores => #scoresに出力
    }

    function drawLinks() {
      ctx.strokeStyle = "gray";
      ctx.lineWidth = 2;
      let drawnLinks = new Set();
      for (let id in nodes) {
        const nd = nodes[id];
        if (!nd.links) continue;
        for (let t of nd.links) {
          if(!(t in nodes)) continue;
          let key = [id,t].sort().join("-");
          if(drawnLinks.has(key)) continue;
          drawnLinks.add(key);

          ctx.beginPath();
          ctx.moveTo(nd.x + MAP_OFFSET_X, nd.y + MAP_OFFSET_Y);
          ctx.lineTo(nodes[t].x + MAP_OFFSET_X, nodes[t].y + MAP_OFFSET_Y);
          ctx.stroke();
        }
      }
    }

    function drawNodes() {
      // 例: 陣地の assigned_color をチームカラーに
      let teamBaseColors = {};
      for (let id in nodes) {
        let n = nodes[id];
        if(n.type==="陣地" && n.team && n.assigned_color){
          teamBaseColors[n.team] = n.assigned_color;
        }
      }

      for (let id in nodes) {
        let nd = nodes[id];
        let bs= NODE_SIZES[nd.type] || 15;
        let w = bs*2, h=bs;

        // 占領チームが持つカラーを適用
        let fillColor = "gray";
        if(nd.type==="陣地" && nd.assigned_color){
          fillColor = nd.assigned_color;
        } else if(nd.team && teamBaseColors[nd.team]){
          fillColor = teamBaseColors[nd.team];
        }

        ctx.fillStyle= fillColor;
        ctx.fillRect(
          nd.x + MAP_OFFSET_X - w/2,
          nd.y + MAP_OFFSET_Y - h/2,
          w,h
        );

        // ラベル
        let label = (nd.type==="陣地" && nd.team)? nd.team : nd.name;
        ctx.fillStyle="black";
        ctx.font="12px Arial";
        ctx.textAlign="center";
        ctx.textBaseline="middle";
        ctx.fillText(label, nd.x+MAP_OFFSET_X, nd.y+MAP_OFFSET_Y);

        // 陣地だけ活・得・脅を表示
        if(nd.type==="陣地"){
          let offsetY=15;
          let av_str= nd.display_active || "0";
          let sc= nd.display_score || 0;
          let thr= nd.threat || "";
          ctx.fillText(`活:${av_str} 得:${sc} 脅:${thr}`,
            nd.x+MAP_OFFSET_X,
            nd.y+MAP_OFFSET_Y+offsetY
          );
        }
      }
    }

    function refreshScores(){
      fetch("/api/scores")
        .then(r=>r.json())
        .then(sc=>{
          let txt="";
          for(let tm in sc){
            txt += `${tm} : ${sc[tm]} 点<br>`;
          }
          document.getElementById("scores").innerHTML=txt;
        });
    }

    // 詳細情報表示: 誰がどのマスを占領 & そのマスの得点
    function buildDetailInfo() {
      /* 
        1. nodes から (team,name,score) を集計
        2. #details に出力
      */
      let detailMap = {}; // teamName => array of { nodeName, nodeScore }

      for(let id in nodes) {
        let nd= nodes[id];
        if(!nd.team) continue; // 未占領
        let t= nd.team;
        if(!detailMap[t]) detailMap[t]=[];

        // 得点計算
        let nodeScore=0;
        if(nd.type==="陣地"){
          // オーナーチーム=同じ =>0, 違う=>nd.score
          if(nd.owner_team===nd.team){
            nodeScore=0;
          } else {
            nodeScore= nd.score||0;
          }
        } else {
          // 非陣地ノード
          nodeScore= nd.score||0;
        }

        detailMap[t].push({ nodeName: nd.name, nodeScore });
      }

      let html="";
      for(let team in detailMap){
        html+= `<strong>${team}</strong><br>`;
        detailMap[team].forEach(obj=>{
          html += `　- ${obj.nodeName}: ${obj.nodeScore} 点<br>`;
        });
        html+="<br>";
      }
      document.getElementById("details").innerHTML= html || "（占領情報なし）";
    }

    //=====================================
    // Canvas クリック => チーム割り当て
    //=====================================
    canvas.addEventListener("click",(ev)=>{
      let rect= canvas.getBoundingClientRect();
      let scaleX= canvas.width / rect.width;
      let scaleY= canvas.height/ rect.height;
      let cx= (ev.clientX - rect.left)*scaleX;
      let cy= (ev.clientY - rect.top)*scaleY;

      let clickedId=null;
      for(let id in nodes){
        let nd= nodes[id];
        let bs= NODE_SIZES[nd.type]||15;
        let w= bs*2, h=bs;
        let left= nd.x + MAP_OFFSET_X - w/2;
        let right= nd.x + MAP_OFFSET_X + w/2;
        let top= nd.y + MAP_OFFSET_Y - h/2;
        let bottom= nd.y + MAP_OFFSET_Y + h/2;
        if(cx>=left && cx<=right && cy>=top && cy<=bottom){
          clickedId=id; break;
        }
      }

      if(clickedId){
        let node= nodes[clickedId];
        if(node.type==="陣地" && !node.team){
          let t= prompt("この陣地を占領する冒険団名:","");
          if(t) assignTeam(clickedId,t);
        } else {
          assignTeamDropdown(clickedId,node);
        }
      }
    });

    function assignTeam(nodeId,teamName){
      fetch("/api/assign_team",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({node_id: nodeId, team: teamName})
      })
      .then(r=>r.json())
      .then(d=>{
        console.log(d.message);
        loadMap();             // 再描画 & detailInfo再構築
        fetchAdventureGroups();
      });
    }

    function assignTeamDropdown(nodeId,node){
      let advNames= Object.keys(adventureGroupsCache);
      if(advNames.length===0){
        alert("先に冒険団を作成してください。");
        return;
      }
      let overlay= document.createElement("div");
      overlay.className="overlay";
      let popup= document.createElement("div");
      popup.className="popup";
      popup.innerHTML="<div>占領する冒険団を選択:</div>";
      let sel= document.createElement("select");
      advNames.forEach(nm=>{
        let op= document.createElement("option");
        op.value= nm; op.text= nm;
        sel.appendChild(op);
      });
      popup.appendChild(sel);
      overlay.appendChild(popup);
      document.body.appendChild(overlay);

      let updateSent=false;
      function sendUpdate(){
        if(!updateSent){
          updateSent=true;
          let val= sel.value;
          document.body.removeChild(overlay);
          assignTeam(nodeId,val);
        }
      }
      sel.addEventListener("change",sendUpdate);
      sel.addEventListener("blur",sendUpdate);
      overlay.addEventListener("click",(e)=>{
        if(e.target===overlay){
          document.body.removeChild(overlay);
        }
      });
    }

    //=====================================
    // リセット
    //=====================================
    document.getElementById("resetButton").onclick=()=>{
      fetch("/api/reset",{method:"POST"})
      .then(r=>r.json())
      .then(d=>{
        console.log(d.message);
        loadMap();
        adventureGroupsCache={};
        renderGroupList();
      });
    };

    //=====================================
    // 冒険団管理
    //=====================================
    document.getElementById("refreshGroupListBtn").onclick= fetchAdventureGroups;

    function fetchAdventureGroups(){
      fetch("/api/adventure_groups")
      .then(r=>r.json())
      .then(list=>{
        adventureGroupsCache={};
        list.forEach(g=>{
          adventureGroupsCache[g.group_name]={
            raw_active_value:g.raw_active_value,
            active_total:g.active_total,
            battle_values:g.battle_values,
            territory:g.territory
          };
        });
        renderGroupList();
      });
    }

    function renderGroupList(){
      let div= document.getElementById("groupList");
      div.innerHTML="";
      let ul= document.createElement("ul");
      Object.keys(adventureGroupsCache).forEach(name=>{
        let obj= adventureGroupsCache[name];
        let li= document.createElement("li");
        li.innerHTML= `${name} (拠点:${obj.territory}, 活:${obj.raw_active_value})`;
        li.onclick=()=> fillGroupForm(name);
        ul.appendChild(li);
      });
      div.appendChild(ul);
    }

    function fillGroupForm(name){
      let data= adventureGroupsCache[name];
      document.getElementById("groupNameInput").value= name;
      document.getElementById("activeInput").value= data.raw_active_value || "0";
      document.getElementById("territorySelect").value= data.territory || "";
      let binputs= document.getElementsByClassName("battleInput");
      data.battle_values.forEach((v,i)=>{
        if(binputs[i]) binputs[i].value=v;
      });
    }

    function fetchTerritoryList(){
      fetch("/api/map")
      .then(r=>r.json())
      .then(mp=>{
        let terrs= Object.keys(mp).filter(k=> mp[k].type==="陣地");
        let sel= document.getElementById("territorySelect");
        sel.innerHTML="";
        let empty= document.createElement("option");
        empty.value=""; empty.text="（未選択）";
        sel.appendChild(empty);

        terrs.forEach(t=>{
          let op= document.createElement("option");
          op.value=t; op.text=t;
          sel.appendChild(op);
        });
      });
    }

    document.getElementById("groupForm").addEventListener("submit",(e)=>{
      e.preventDefault();
      let gname= document.getElementById("groupNameInput").value.trim();
      let territory= document.getElementById("territorySelect").value;
      let activeVal= document.getElementById("activeInput").value;
      let bArr= Array.from(document.getElementsByClassName("battleInput")).map(x=> parseFloat(x.value));

      let payload={
        group_name:gname,
        territory:territory,
        active_total:activeVal,
        battle_values:bArr
      };

      fetch("/api/adventure_groups",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      })
      .then(r=>r.json())
      .then(d=>{
        if(d.error){
          document.getElementById("adventureResult").innerHTML= `<span style='color:red;'>${d.error}</span>`;
        } else {
          document.getElementById("adventureResult").innerText= d.message;
          fetchAdventureGroups();
          loadMap();
        }
      });
    });
  </script>
</body>
</html>
