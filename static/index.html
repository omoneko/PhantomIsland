<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>陣取りシミュレーション</title>
  <style>
    /* ★ PC向けデフォルトレイアウト ★ */
    #container {
      display: flex;
      flex-direction: row;  /* PCでは左右に分割 */
      width: 1200px;       /* 全体幅を固定 */
      margin: 0 auto;      /* 中央寄せ */
      height: 700px;       /* キャンバスの高さに合わせる */
      align-items: flex-start;
    }

    #left-pane {
      /* PC時は特に制限なし */
    }

    #right-pane {
      width: 200px;
      padding: 10px;
      border-left: 1px solid black;
      font-family: Arial, sans-serif;
      overflow-y: auto;
      box-sizing: border-box;
    }

    canvas {
      border: 1px solid black;
      display: block;
      /* PC時は 1000×700 で表示 */
      width: 1000px;
      height: 700px;
    }

    /* ★ メディアクエリ: 768px以下(スマホ)でレイアウト切り替え ★ */
    @media screen and (max-width: 768px) {
      #container {
        flex-direction: column;   /* 上下に分割 */
        width: 100%;             /* 画面幅いっぱい */
        height: auto;           /* 高さ自動 */
      }
      #right-pane {
        border-left: none;      /* 左境界線を消す */
        border-top: 1px solid black; /* 代わりに上端に線 */
        width: 100%;           /* 画面幅に合わせる */
      }
      canvas {
        /* キャンバスを画面幅に合わせて縮小 */
        width: 100% !important;
        height: auto !important;
      }
    }

    /* オーバーレイのスタイル */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .popup {
      background-color: white;
      padding: 20px;
      border-radius: 5px;
    }

    button {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <!-- タブ切り替え部分 -->
  <div style="padding:10px; border-bottom:1px solid #ccc;">
    <button id="simulationTab">シミュレーション</button>
    <button id="adventureTab">冒険団管理</button>
  </div>

  <!-- シミュレーション画面 -->
  <div id="simulationSection">
    <div id="container">
      <div id="left-pane">
        <canvas id="gameCanvas" width="1000" height="700"></canvas>
      </div>
      <div id="right-pane">
        <h3>得点表示</h3>
        <div id="scores"></div>
        <button id="resetButton">リセット</button>
        <h3>詳細</h3>
        <div id="details">（詳細情報表示エリア）</div>
      </div>
    </div>
  </div>

  <!-- 冒険団管理画面 -->
  <div id="adventureSection" style="display:none; padding:10px;">
    <h3>冒険団の新規作成/編集</h3>
    <div>
      <button id="refreshGroupListBtn">冒険団一覧更新</button>
    </div>
    <div id="groupList"></div>

    <form id="groupForm">
      <div>
        <label>冒険団名: </label>
        <input type="text" id="groupNameInput" required />
      </div>
      <div>
        <label>陣地ID: </label>
        <select id="territorySelect"></select>
      </div>
      <div>
        <label>アクティブ値: </label>
        <!-- 3億など文字入力でもOK -->
        <input type="text" id="activeInput" value="0" required />
      </div>
      <div>
        <label>上位5人の戦力値:</label><br>
        <input type="number" class="battleInput" step="any" value="0" required />
        <input type="number" class="battleInput" step="any" value="0" required />
        <input type="number" class="battleInput" step="any" value="0" required />
        <input type="number" class="battleInput" step="any" value="0" required />
        <input type="number" class="battleInput" step="any" value="0" required />
      </div>
      <button type="submit">保存</button>
    </form>
    <div id="adventureResult" style="margin-top:10px; color:blue;"></div>
  </div>

  <script>
    /* ここにJSロジックをフル実装
       - loadMap(), drawLinks(), drawNodes(), refreshScores()
       - buildDetailInfo() (必要に応じ)
       - assignTeam(), fetchAdventureGroups(), etc.
       PC/スマホ両対応するにはメディアクエリが要。 */

    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    let nodes = {};
    let adventureGroupsCache = {};

    const NODE_SIZES = {
      "コンビニ": 15,
      "スーパー": 20,
      "ホール": 25,
      "陣地": 30,
      "中心大厦": 35
    };

    // フラグなど: スマホなら特定の操作を簡易化してもOK

    // タブ切り替え
    const simulationSection = document.getElementById("simulationSection");
    const adventureSection = document.getElementById("adventureSection");
    document.getElementById("simulationTab").onclick = () => {
      simulationSection.style.display = "block";
      adventureSection.style.display = "none";
    };
    document.getElementById("adventureTab").onclick = () => {
      simulationSection.style.display = "none";
      adventureSection.style.display = "block";
      fetchAdventureGroups();
    };

    // === 初期ロード例 ===
    loadMap();
    fetchAdventureGroups();
    fetchTerritoryList();

    function loadMap() {
      fetch("/api/map")
        .then(r => r.json())
        .then(data => {
          nodes = data;
          drawAll();
        });
    }

    function drawAll() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawLinks();
      drawNodes();
      refreshScores();
    }

    function drawLinks() {
      // 省略: 同様に
    }

    function drawNodes() {
      // 省略: 同様に
    }

    function refreshScores() {
      fetch("/api/scores")
        .then(r => r.json())
        .then(sc => {
          let html = "";
          for (let tm in sc) {
            html += `${tm} : ${sc[tm]} 点<br>`;
          }
          document.getElementById("scores").innerHTML = html;
        });
    }

    document.getElementById("resetButton").onclick = () => {
      fetch("/api/reset", { method:"POST" })
        .then(r => r.json())
        .then(d => {
          console.log(d.message);
          loadMap();
          adventureGroupsCache = {};
          renderGroupList();
        });
    };

    function fetchAdventureGroups() {
      fetch("/api/adventure_groups")
        .then(r => r.json())
        .then(list => {
          adventureGroupsCache = {};
          list.forEach(g => {
            adventureGroupsCache[g.group_name] = {
              raw_active_value: g.raw_active_value,
              active_total: g.active_total,
              battle_values: g.battle_values,
              territory: g.territory
            };
          });
          renderGroupList();
        });
    }

    function renderGroupList() {
      let div = document.getElementById("groupList");
      div.innerHTML = "";
      let ul = document.createElement("ul");
      Object.keys(adventureGroupsCache).forEach(name => {
        let obj = adventureGroupsCache[name];
        let li = document.createElement("li");
        li.innerHTML = `${name} (拠点:${obj.territory}, 活:${obj.raw_active_value})`;
        li.onclick = () => fillGroupForm(name);
        ul.appendChild(li);
      });
      div.appendChild(ul);
    }

    function fillGroupForm(name) {
      let data = adventureGroupsCache[name];
      document.getElementById("groupNameInput").value = name;
      document.getElementById("activeInput").value = data.raw_active_value || "0";
      document.getElementById("territorySelect").value = data.territory || "";
      let binputs = document.getElementsByClassName("battleInput");
      data.battle_values.forEach((v,i)=>{
        if(binputs[i]) binputs[i].value = v;
      });
    }

    function fetchTerritoryList() {
      fetch("/api/map")
        .then(r=>r.json())
        .then(mp => {
          let terrs = Object.keys(mp).filter(k=> mp[k].type==="陣地");
          let sel = document.getElementById("territorySelect");
          sel.innerHTML = "";
          let empty = document.createElement("option");
          empty.value = "";
          empty.text = "（未選択）";
          sel.appendChild(empty);
          terrs.forEach(t => {
            let op = document.createElement("option");
            op.value = t;
            op.text = t;
            sel.appendChild(op);
          });
        });
    }

    document.getElementById("groupForm").addEventListener("submit", e => {
      e.preventDefault();
      let gname = document.getElementById("groupNameInput").value.trim();
      let territory = document.getElementById("territorySelect").value;
      let activeVal = document.getElementById("activeInput").value;
      let bArr = Array.from(document.getElementsByClassName("battleInput"))
                      .map(x=> parseFloat(x.value));

      let payload = {
        group_name: gname,
        territory: territory,
        active_total: activeVal,
        battle_values: bArr
      };

      fetch("/api/adventure_groups", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      })
      .then(r=>r.json())
      .then(d=>{
        if(d.error){
          document.getElementById("adventureResult").innerHTML= `<span style='color:red;'>${d.error}</span>`;
        } else {
          document.getElementById("adventureResult").innerText= d.message;
          fetchAdventureGroups();
          loadMap();
        }
      });
    });
  </script>
</body>
</html>
